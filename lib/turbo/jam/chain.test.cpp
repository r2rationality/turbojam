/* This file is part of TurboJam project: https://github.com/r2rationality/turbojam/
 * Copyright (c) 2025 R2 Rationality OÃœ (info at r2rationality dot com)
 * This code is distributed under the license specified in:
 * https://github.com/r2rationality/turbojam/blob/main/LICENSE */

#include <turbo/common/test.hpp>
#include "chain.hpp"

namespace {
    using namespace turbo;
    using namespace turbo::jam;
}

suite turbo_jam_chain_suite = [] {
    "turbo::jam::chain"_test = [] {
        "import block"_test = [] {
            const auto block_raw = uint8_vector::from_hex("100700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001EE155ACE9C40292074CB6AFF8C9CCDD273C81648FF1149EF36BCEA6EBB8A3E25BB30A42C1E62F0AFDA5F0A4E8A562F7A13A24CEA00EE81917B86B89E801314AAFF71C6C03FF88ADB5ED52C9681DE1629A54E702FC14729F6B50D2F0A76F185B34418FB8C85BB3985394A8C2756D3643457CE614546202A2F50B093D762499ACEDEE6D555B82024F1CCF8A1E37E60FA60FD40B1958C4BB3006AF78647950E1B91AD93247BD01307550EC7ACD757CE6FB805FCF73DB364063265B30A949E90D9339326EDB21E5541717FDE24EC085000B28709847B8AAB1AC51F84E94B37CA1B66CAB2B9FF25C2410FBE9B8A717ABB298C716A03983C98CEB4DEF2087500B8E3410746846D17469FB2F95EF365EFCAB9F4E22FA1FEB53111C995376BE8019981CCF30AA5444688B3CAB47697B37D5CAC5707BB3289E986B19B17DB437206931A8D151E5C8FE2B9D8A606966A79EDD2F9E5DB47E83947CE368CCBA53BF6BA20A40B8B8C5D436F92ECF605421E873A99EC528761EB52A88A2F9A057B3B3003E6F32A2105650944FCD101621FD5BB3124C9FD191D114B7AD936C1D79D734F9F21392EAB0084D01534B31C1DD87C81645FD762482A90027754041CA1B56133D0466C060000FFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B5AF8EDAD70D962097EEFA2CEF92C8284CF0A7578B70A6B7554CF53AE6D5122241991E28BC9512B451E90178FC79D2AD1EDE74FE86FAAE1DAAAD7A5182C105CF189D15AF832DFE4F67744008B62C334B569FCBB4C261E0F065655697306CA25219D520000103170A2E7597B7B7E3D84C05391D139A62B157E78786D8C082F29DCF4C111314EE155ACE9C40292074CB6AFF8C9CCDD273C81648FF1149EF36BCEA6EBB8A3E25FF71C6C03FF88ADB5ED52C9681DE1629A54E702FC14729F6B50D2F0A76F185B34418FB8C85BB3985394A8C2756D3643457CE614546202A2F50B093D762499ACEDEE6D555B82024F1CCF8A1E37E60FA60FD40B1958C4BB3006AF78647950E1B91AD93247BD01307550EC7ACD757CE6FB805FCF73DB364063265B30A949E90D9339326EDB21E5541717FDE24EC085000B28709847B8AAB1AC51F84E94B37CA1B66CAB2B9FF25C2410FBE9B8A717ABB298C716A03983C98CEB4DEF2087500B8E3410746846D17469FB2F95EF365EFCAB9F4E22FA1FEB53111C995376BE8019981CCF30AA5444688B3CAB47697B37D5CAC5707BB3289E986B19B17DB437206931A8D151E5C8FE2B9D8A606966A79EDD2F9E5DB47E83947CE368CCBA53BF6BA20A40B8B8C5D436F92ECF605421E873A99EC528761EB52A88A2F9A057B3B3003E6F32A2105650944FCD101621FD5BB3124C9FD191D114B7AD936C1D79D734F9F21392EAB0084D01534B31C1DD87C81645FD762482A90027754041CA1B56133D0466C0600000100BE3A3B0B8C77B7106965E2406408665E68E3A87A05CAB8C7558774745F126A48B11DB2D23EE5D383AE6709862E249B75E525BB9C2F45BFAF67647582E6A10309DE199F374E766937B342536495C12488540AB70A7A56FFB77B5E5F0F4BAE6F1B4B78E92BCA286B63F52BE7D326B38EF0F22B170C5059F92E71A2BAAF7553348A1C2A3B246E37A685CF9D580DC9BA57494D3628DE588DE6A1F1190FC4E321EA05CD68F48FA458523546CC068958D219CCB10A0BF00FC1501DB8DD8F0FA76CD2040000000000000000E02D4EDC3076BD604A81EBFBC7D9CE6EE1C48705CE313136B78B873B29FFE2B2BE0B6BDE3902F552F5AC508F239206E97CC834384C542DC99DF0645B4993DB189D15AF832DFE4F67744008B62C334B569FCBB4C261E0F065655697306CA2521BD520000000000100BE3A3B0B8C77B7106965E2406408665E68E3A87A05CAB8C7558774745F126A48B11DB2D23EE5D383AE6709862E249B75E525BB9C2F45BFAF67647582E6A10309DE199F374E766937B342536495C12488540AB70A7A56FFB77B5E5F0F4BAE6F1B4B78E92BCA286B63F52BE7D326B38EF0F22B170C5059F92E71A2BAAF7553348ADBE324EDC60B449BF7F65AE31B74C1BF886941904C9E7AD2E4AF6E1EA20E84123831E5F86F1DB3F54C5B1A5FA609F267CD51EB7F1ACD722BACD939FB80D6D71C00000000000000");
            decoder dec { block_raw };
            const auto msg_size = dec.uint_fixed<size_t>(4);
            expect_equal(msg_size, block_raw.size() - 4);
            const auto block1 = codec::from<block_t<config_tiny>>(dec);
            expect_equal(
                header_hash_t::from_hex("B5AF8EDAD70D962097EEFA2CEF92C8284CF0A7578B70A6B7554CF53AE6D51222"),
                block1.header.hash()
            );
            const auto block2 = codec::from<block_t<config_tiny>>(dec);
            expect_equal(
                header_hash_t::from_hex("00E02D4EDC3076BD604A81EBFBC7D9CE6EE1C48705CE313136B78B873B29FFE2"),
                block2.header.hash()
            );
            expect_equal(block1.header.hash(), block2.header.parent);
            const auto block3 = codec::from<block_t<config_tiny>>(dec);
            expect_equal(
                header_hash_t::from_hex("5FF61E1F3F7C3483CD80E2464961BC2AD17D9B3BDCE57F21160EC6E7DB12F296"),
                block3.header.hash()
            );
            expect_equal(block2.header.hash(), block3.header.parent);
            expect(dec.empty());
        };
        "state root"_test = [] {
            const auto j_cfg = codec::json::load(file::install_path("etc/devnet/dev-spec.json"));
            const state_dict_t st = state_dict_t::from_genesis_json(j_cfg.at("genesis_state"));
            expect_equal(
                state_root_t::from_hex("957C2FDE59ED6EC1249BBE4CAB260B29BE0A03504181A491CE8C9522661CD3A6"),
                st.root()
            );
        };
        "parse config"_test = [] {
            const file::tmp_directory data_dir { "test-jam-chain" };
            const auto chain = chain_t<config_tiny>::from_json_spec(data_dir.path(), file::install_path("etc/devnet/dev-spec.json"));
            expect_equal("dev", chain.id());
            expect_equal(
                header_hash_t::from_hex("B5AF8EDAD70D962097EEFA2CEF92C8284CF0A7578B70A6B7554CF53AE6D51222"),
                chain.genesis_header().hash()
            );
            expect_equal(
                header_hash_t::from_hex("0000000000000000000000000000000000000000000000000000000000000000"),
                chain.genesis_header().parent
            );
            expect_equal(
                header_hash_t::from_hex("0000000000000000000000000000000000000000000000000000000000000000"),
                chain.genesis_header().parent_state_root
            );
            expect_equal(
                header_hash_t::from_hex("0000000000000000000000000000000000000000000000000000000000000000"),
                chain.genesis_header().extrinsic_hash
            );
            expect_equal(
                std::numeric_limits<validator_index_t>::max(),
                chain.genesis_header().author_index
            );
            expect_equal(
                state_root_t::from_hex("1AA8679E417E7771F60FE4FC90E52A88E615C991A5810A5DC439A2EE0B7ED08B"),
                chain.genesis_state().root()
            );
        };
        "testnet"_test = [] {
            const auto bytes = uint8_vector::from_hex(file::read(file::install_path("test/devnet-data/blocks-000.hex")).str());
            decoder dec { bytes };
            const auto msg_size = dec.uint_fixed<size_t>(4);
            expect_equal(msg_size, bytes.size() - 4ULL);
            expect(!dec.empty());
            const file::tmp_directory data_dir { "test-jam-chain" };
            auto chain = chain_t<config_tiny>::from_json_spec(data_dir.path(), file::install_path("etc/devnet/dev-spec.json"));
            for (size_t blk_no = 0; !dec.empty(); ++blk_no) {
                const auto blk = codec::from<block_t<config_tiny>>(dec);
                logger::info("chain state_root: {}", chain.state_root());
                logger::info("block #{}: hash={} parent={} parent_root={}",
                    blk_no, blk.header.hash(), blk.header.parent, blk.header.parent_state_root);
                chain.apply(blk);

            }
        };
    };
};
